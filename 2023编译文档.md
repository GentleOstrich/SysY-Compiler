# 2023编译文档

## 参考编译器介绍

## 编译器总体设计

### 总体结构

由三部分组成：前端、中端、后端。

前端：负责词法分析与语法分析，产生语法树。同时负责词法错误处理和语法错误处理。

中端：遍历语法树，生成LLVM中间代码。同时负责符号表管理与语义错误处理。

后端：按照LLVM的结构，遍历中间代码，生成MIPS目标代码。

### 接口设计

#### 前端

读入源程序，返回语法树。其中词法分析器Lexer为语法分析器Parser提供读取下一个token的接口。

#### 中端

读入前端生成语法树，返回LLVM的module。

#### 后端

读入中端生成的LLVM-module，生成MIPS目标代码。

### 文件组织

<ul>
  <li>Frontend</li>
    <ul>
      <li>Lexer</li>
      <li>Parser</li>
      <li>NonterminalCharacter</li>
    </ul>
  <li>IR</li>
    <ul>
      <li>SymbolManager</li>
      <li>Values</li>
      <ul>
        <li>Instructions</li>
      </ul>
    </ul>
    <li>Backend</li>
    <ul>
      <li>MipsInstructions</li>
    </ul>
</ul>

## 词法分析设计

### 编码前的设计

词法分析器Lexer通过next函数返回下一个token的名字和类型

### 编码完成之后的修改

增加两个函数，nnext和nnnext，通过它们预读取下两个和下三个token的信息，在语法分析生成语法树阶段会用到这两个函数。

## 语法分析设计

### 编码前的设计

调用词法分析器Lexer提供的next接口，获得当前token的信息。根据文法规则、当前token的信息、调用Lexer相应接口预读到的token信息，对解析哪个语法树非终结符进行判断。

### 编码完成之后的修改

对每个非终结符建类，这些非终结符和终结符作为语法树的结点，通过指针连接，生成语法树。

## 错误处理设计

错误处理涉及词法错误、语法错误、语义错误。

词法错误（a）：在Lexer中对格式字符串进行检查。

语法错误（i j k）：在语法分析器Parser中对缺少; ) ]进行检查。

语义错误（b c d e f g h i）：在语义分析器Visitor中，建立符号表，结合符号表进行名字重定义等语义错误的检查与处理。

### 编码前的设计

将语义分析与语法错误程序混合在一起，进行一边处理，在这个阶段生成符号表，并进行语义错误检查与处理。

### 编码完成之后的修改

符号类及符号表：因为LLVM的value类中记录了近乎全面的语义信息，所以结合LLVM的value类建立符号类，生成符号表。



## 代码生成设计

### 编码前的设计



### 编码完成之后的修改

